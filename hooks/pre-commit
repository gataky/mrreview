#!/bin/sh
# Pre-commit hook for mrreviewer
# Runs formatting, linting, and tests before committing

set -e

echo "ðŸ” Running pre-commit checks..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Get list of staged Lua files
STAGED_LUA_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.lua$' || true)

if [ -z "$STAGED_LUA_FILES" ]; then
    echo "${GREEN}âœ“${NC} No Lua files to check"
    exit 0
fi

echo "Checking ${STAGED_LUA_FILES}" | wc -l | xargs echo "files..."

# Check if stylua is installed
if command -v stylua >/dev/null 2>&1; then
    echo "ðŸ“ Formatting with stylua..."
    if stylua --check $STAGED_LUA_FILES; then
        echo "${GREEN}âœ“${NC} Code formatting passed"
    else
        echo "${YELLOW}âš ${NC}  Formatting issues found. Running stylua --fix..."
        stylua $STAGED_LUA_FILES
        # Re-stage formatted files
        git add $STAGED_LUA_FILES
        echo "${GREEN}âœ“${NC} Code formatted and re-staged"
    fi
else
    echo "${YELLOW}âš ${NC}  stylua not found, skipping formatting check"
    echo "   Install with: cargo install stylua"
fi

# Check if luacheck is installed
if command -v luacheck >/dev/null 2>&1; then
    echo "ðŸ”Ž Linting with luacheck..."
    if luacheck $STAGED_LUA_FILES; then
        echo "${GREEN}âœ“${NC} Linting passed"
    else
        echo "${RED}âœ—${NC} Linting failed"
        echo "   Fix the issues above or commit with --no-verify to skip"
        exit 1
    fi
else
    echo "${YELLOW}âš ${NC}  luacheck not found, skipping linting"
    echo "   Install with: luarocks install luacheck"
fi

# Run tests if plenary is available
if [ -d "tests" ] && [ -f "tests/minimal_init.lua" ]; then
    if command -v nvim >/dev/null 2>&1; then
        echo "ðŸ§ª Running tests..."
        if nvim --headless --noplugin -u tests/minimal_init.lua -c "PlenaryBustedDirectory tests/ { minimal_init = 'tests/minimal_init.lua' }" 2>&1 | grep -q "Success:"; then
            echo "${GREEN}âœ“${NC} Tests passed"
        else
            echo "${RED}âœ—${NC} Tests failed"
            echo "   Fix the failing tests or commit with --no-verify to skip"
            exit 1
        fi
    fi
else
    echo "${YELLOW}âš ${NC}  Test framework not set up, skipping tests"
fi

echo "${GREEN}âœ“${NC} All pre-commit checks passed!"
exit 0
